Info2: <<

Package: qgis18-py%type_pkg[python]
Type: python (2.7 2.6)
Architecture: powerpc, i386, x86_64
Distribution: 10.5, 10.6, 10.7

Version: 1.8.0
Revision: 1
Description: User friendly Open Source GIS
License: GPL
Homepage: http://qgis.org
Maintainer: BABA Yoshihiko <babayoshihiko@mac.com>
DescDetail: <<
	Quantum GIS (QGIS) is a Geographic Information System (GIS) 
that runs on Linux, Unix, Mac OSX, and Windows. QGIS supports 
vector, raster, and database formats. QGIS is licensed 
under the GNU Public License.

	Some of the major features include:
	1 Support for spatially enabled PostGIS tables
	2 Support for shapefiles, ArcInfo coverages, Mapinfo, 
	            and other formats supported by OGR
	3 Raster support for a large number of formats
	4 Identify features
	5 Display attribute tables
	6 Select features
	7 GRASS Digitizing
	8 Feature labeling
<<

DescUsage: << 
	Just double click 'QGIS-py%type_pkg[python]-%v.app' 
in /Applications/Fink.
<<

# Dependencies.
# Depends: qgis-plugin-installer
BuildDepends: << 
	fink (>= 0.28), cmake, bison (>= 2.3),
	gsl,
	qt4-base-mac, 
	sip-py%type_pkg[python]-bin, pyqt4-mac-py%type_pkg[python] , 
	xerces-c31-dev,
	libiconv-dev, giflib, libtiff, libjpeg8, libogdi3 (>= 3.1.5-1), libpng15, netcdf (>= 3.6.0-1002), 
	cfitsio,
	unixodbc2-nox (>= 2.2.11-1010) | unixodbc2 (>= 2.2.11-1010), 
	libgeos3.3.3,
	gdal-dev | gdal-pgsql-dev, 
	postgresql90-dev, 
	grass64-mac-dev | grass64-mac-dev,
	proj (>=4),
	qwt6-qt4-mac,
	libspatialindex2,
	libspatialite5
<<
BuildConflicts: libspatialite1

# Unpack Phase.
Source: http://qgis.org/downloads/qgis-%v.tar.bz2
Source-MD5: 1d60520f81d7763c026d0af887ac9a05
SourceDirectory: qgis-%v

# Compile Phase.
GCC: 4.0

SetCFLAGS: -fno-common
SetLDFLAGS: -liconv
CompileScript: <<
#!/bin/bash -ev

	# Find Fink's PyQt4
	PY_VER=%type_raw[python]
	perl -pi -e 's|sys.path = \[\\\"\"|sys.path = \[\\\"%p/lib/qt4-mac/lib/python'${PY_VER}'/site-packages\\", \\"\"|' src/python/qgspythonutilsimpl.cpp
	perl -pi -e 's|\.app|-py%type_pkg[python]-%v.app|' CMakeLists.txt
	
	export QTDIR=%p/lib/qt4-mac
	export PYTHONPATH=%p/lib/qt4-mac/lib/python$PY_VER/site-packages:$PYTHONPATH
	export PATH=%p/lib/qt4-mac/lib/python$PY_VER/bin:$PATH
	
	QGIS_DIR=Applications/QGIS-py%type_pkg[python]-%v.app/Contents
	
	# Lion
	if [[ $( sw_vers -productVersion ) > 10.7 ]]; then
	  export CC=gcc-fsf-4.6
	fi
	
	QGIS_OPTIONS="-D QGIS_APP_NAME=QGIS-py%type_pkg[python]-%v
					-D CMAKE_PREFIX_PATH=%p
					-D EXECUTABLE_OUTPUT_PATH=%b/build/src/mac/Contents/MacOS
					-D CMAKE_INSTALL_PREFIX=%b/Applications
					-D GDAL_INCLUDE_DIR=%p/include/gdal1
					-D GEOS_CONFIG=%p/opt/libgeos3.3.3/bin/geos-config
					-D QT_BINARY_DIR=%p/lib/qt4-mac/bin
					-D QT_INCLUDE_DIR=%p/lib/qt4-mac/include
					-D QT_QMAKE_EXECUTABLE=%p/lib/qt4-mac/bin/qmake
					-D PYTHON_INCLUDE_PATH=%p/include/python$PY_VER
					-D PYTHON_LIBRARY=%p/lib/python$PY_VER/config/libpython$PY_VER.dylib
					-D PYTHON_EXECUTABLE=%p/bin/python$PY_VER
					-D PYUIC4_PROGRAM=%p/lib/qt4-mac/lib/python$PY_VER/bin/pyuic4
					-D SIP_INCLUDE_DIR=%p/include/python$PY_VER
					-D SIP_BINARY_PATH=%p/bin
					-D POSTGRES_CONFIG=%p/bin/pg_config
					-D GRASS_PREFIX=%p/Applications/GRASS-6.4.app/Contents/MacOS"
					# -DQ_WS_WIN:INTERNAL=${Q_WS_WIN} \
					# -DQ_WS_X11:INTERNAL=${Q_WS_X11} \
					# -DQ_WS_QWS:INTERNAL=${Q_WS_QWS} \
	QGIS_VERSION_OPTIONS="-D CMAKE_BUILD_TYPE=Release
					-D ENABLE_TESTS=FALSE
					-D WITH_INTERNAL_SPATIALITE=FALSE
					-D WITH_PYSPATIALITE=FALSE
					-D QWT_LIBRARY=%p/lib/qt4-mac/lib/qwt.framework/Versions/6/qwt
  					-D QWT_INCLUDE_DIR=%p/lib/qt4-mac/lib/qwt.framework/Versions/6/Headers/
  					-D BISON_EXECUTABLE=%p/bin/bison
  					-D WITH_MAPSERVER=FALSE
  					-D QTPREFIX=%p/$QGIS_DIR/Frameworks
  					-D QGIS_MACAPP_DEV_PREFIX=%p/$QGIS_DIR/Frameworks
  					-D QGIS_FW_SUBDIR=%p/$QGIS_DIR/Frameworks
  					-D QGIS_MACAPP_BUNDLE=0"
  	# QTPREFIX, QGIS_*: to set install name, though they don't seem to be effective.
  	# QGIS_MACAPP_BUNDLE 
	# 0 = (default) fixup the library paths for all QGIS libraries if @loader_path
	#     is available in the system (OS X 10.5+)
	# 1 = bundle Qt, PyQt and PyQwt
	# 2 = additionally, bundle libraries, but not frameworks
  	
  	perl -pi -e "s|@executable_path|%p/$QGIS_DIR/MacOS|g" mac/extras/1-release-extra.sh
  	
	mkdir build
	pushd build
	cmake $QGIS_OPTIONS $QGIS_VERSION_OPTIONS ..
	
	# 1.8.0 Fix hardcoded application name
	perl -pi -e "s|QGIS.app|QGIS-py%type_pkg[python]-%v.app|g" src/app/cmake_install.cmake
	perl -pi -e "s|QGIS.app|QGIS-py%type_pkg[python]-%v.app|g" src/app/CMakeFiles/QGIS.dir/build.make
	perl -pi -e "s|QGIS.app|QGIS-py%type_pkg[python]-%v.app|g" src/app/CMakeFiles/QGIS.dir/link.txt
	perl -pi -e "s|QGIS.app|QGIS-py%type_pkg[python]-%v.app|g" src/app/CMakeFiles/QGIS.dir/cmake_clean.cmake
	perl -pi -e "s|Qgis.app|QGIS-py%type_pkg[python]-%v.app|g" ../xcode/qgis_settings.xcconfig:QGIS_APP_NAME = Qgis.app
	perl -pi -e "s|Qgis.app|QGIS-py%type_pkg[python]-%v.app|g" ../xcode/Qgis.xcodeproj/project.pbxproj
	mkdir -p output/bin/QGIS-py%type_pkg[python]-%v.app/Contents/MacOS
	ln -s output/bin/QGIS-py%type_pkg[python]-%v.app output/bin/QGIS.app
	
	# 1.8.0 Workaround from MacPorts
	echo "install_name_tool -change @executable_path/../Frameworks/qgis_core.framework/Versions/1.8/qgis_core @executable_path/../lib/qgis_core.framework/Versions/1.8/qgis_core ../../output/bin/crssync"  >> src/crssync/CMakeFiles/crssync.dir/link.txt
	
	make VERBOSE=1 
	make install CMAKE_INSTALL_PREFIX=%b SIP_MAC_PATH=%p/bin
	popd
	
	# 1.7.0 Tell qgis to read Fink's environmental variables
	pushd $QGIS_DIR/MacOS
	mv QGIS QGIS.exe
	echo '#!/bin/sh' >QGIS
	echo ". %p/bin/init.sh && %p/$QGIS_DIR/MacOS/QGIS.exe" >>QGIS
	chmod 555 QGIS
		# 1.8.0
		install_name_tool -id %p/$QGIS_DIR/MacOS/QGIS.exe QGIS.exe
		for loader in qgis_analysis qgis_core qgis_gui qgis_networkanalysis qgisgrass qgissqlanyconnection
		do
			install_name_tool -change @executable_path/../Frameworks/$loader.framework/$loader %p/$QGIS_DIR/Frameworks/$loader.framework/$loader QGIS.exe
		done
	popd
	
	# 1.6.0 Plugins are now managed by their own package (e.g. qgis-plugin-ftools)
	# rm -rf %b/$QGIS_DIR/Resources/python/plugins
	# ln -s %p/share/qgis/python/plugins %b/Applications/QGIS-py%type_pkg[python]-%v.app/Contents/Resources/python/plugins
	  
	# 1.6.0 Workaround to SJIS problem
	mkdir -p %b/$QGIS_DIR/PlugIns
	ln -s %p/lib/qt4-mac/plugins/codecs %b/$QGIS_DIR/PlugIns/codecs

	# 1.6.0 Recompile python scripts to fix path
	%p/bin/python$PY_VER %p/lib/python$PY_VER/compileall.py -f -d %p/$QGIS_DIR/Resources/python/qgis %b/$QGIS_DIR/Resources/python/qgis
	%p/bin/python$PY_VER -O %p/lib/python$PY_VER/compileall.py -f -d %p/$QGIS_DIR/Resources/python/qgis %b/$QGIS_DIR/Resources/python/qgis

	# 1.8.0 Fix install name for Fink's policy
	pushd $QGIS_DIR/MacOS/lib
	for libname in libqgispython.1.8.0
	do
		install_name_tool -id %p/$QGIS_DIR/MacOS/lib/$libname.dylib $libname.dylib
		for loader in QtCore QtGui QtMultimedia QtNetwork QtOpenGL QtSql QtSvg QtWebKit QtXml QtXmlPatterns qgis_core
		do
			install_name_tool -change @loader_path/../../Frameworks/$loader.framework/$loader %p/lib/qt4-mac/lib/$loader.framework/Versions/4/$loader $libname.dylib
		done
	done
	popd
	
	pushd $QGIS_DIR/Frameworks
	for libname in qgis_analysis qgis_core qgis_gui qgis_networkanalysis qgisgrass qgissqlanyconnection
	do
		install_name_tool -id %p/$QGIS_DIR/Frameworks/$libname.framework/$libname $libname.framework/$libname 
	done
	popd
	
	pushd $QGIS_DIR/MacOS/bin/qbrowser.app/Contents/Frameworks/
	for libname in qgis_analysis qgis_core qgis_gui qgis_networkanalysis qgisgrass qgissqlanyconnection
	do
		install_name_tool -id %p/$QGIS_DIR/Frameworks/$libname.framework/$libname $libname.framework/$libname 
	done
	popd

	pushd $QGIS_DIR/MacOS/bin/qgis_help.app/Contents/Frameworks/
	for libname in qgis_analysis qgis_core qgis_gui qgis_networkanalysis qgisgrass qgissqlanyconnection
	do
		install_name_tool -id %p/$QGIS_DIR/Frameworks/$libname.framework/$libname $libname.framework/$libname 
	done
<<
InstallScript: <<
#!/bin/bash -ev
	# Uses AppBundles which copies files from the build directory.
	echo "Completed the building process..."
<<

AppBundles: Applications/QGIS-py%type_pkg[python]-%v.app

Depends: <<
	qt4-base-mac-qtcore-shlibs, 
	python%type_pkg[python], sip-py%type_pkg[python], pyqt4-mac-py%type_pkg[python], 
	gsl-shlibs,
	xerces-c31-shlibs,
	libgeos3.3.3-shlibs,
	gdal-shlibs | gdal-pgsql-shlibs, 
	grass64-mac-shlibs | grass64-x11-shlibs,
	libspatialite5-shlibs,
	proj-shlibs (>=4),
	qwt6-qt4-mac-shlibs,
	libspatialindex2-shlibs
<<

Shlibs: <<
	%p/Applications/QGIS-py%type_pkg[python]-%v.app/Contents/MacOS/lib/libqgispython.1.8.0.dylib	1.8.0 %n (>= 1.8.0-1)
	!%p/Applications/QGIS-py%type_pkg[python]-%v.app/Contents/MacOS/lib/libqgispython.dylib
<<

DescPackaging: <<
	Since 1.7.0, 
	  1. qgis has Python variants, 
	    e.g. qgis17-py31 and qgis17-py27.
	  2. separates all the python plugins
	    as independent packages.
	
	For consistency, qgis and relevant packages are strongly recommended to depend on 
the latest stable versions, e.g.:
	  postgresql90,
	  grass64,
	  libgeos3.3.3,
	  libjpeg8, libogdi3, libpng14
<<
DescPort: <<
	See INSTALL
	See http://wiki.qgis.org/qgiswiki/BuildingFromSource
<<

# End of Info2
<<
