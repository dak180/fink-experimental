diff -Nurd -x'*~' glib-2.48.1.orig/docs/reference/gio/Makefile.in glib-2.48.1/docs/reference/gio/Makefile.in
--- glib-2.48.1.orig/docs/reference/gio/Makefile.in	2016-05-10 05:05:54.000000000 -0400
+++ glib-2.48.1/docs/reference/gio/Makefile.in	2016-07-08 01:56:12.000000000 -0400
@@ -93,15 +93,15 @@
 POST_UNINSTALL = :
 build_triplet = @build@
 host_triplet = @host@
-@ENABLE_MAN_TRUE@am__append_1 = \
-@ENABLE_MAN_TRUE@	gapplication.1		\
-@ENABLE_MAN_TRUE@	gio-querymodules.1	\
-@ENABLE_MAN_TRUE@	glib-compile-schemas.1	\
-@ENABLE_MAN_TRUE@	glib-compile-resources.1	\
-@ENABLE_MAN_TRUE@	gsettings.1		\
-@ENABLE_MAN_TRUE@	gresource.1		\
-@ENABLE_MAN_TRUE@	gdbus.1			\
-@ENABLE_MAN_TRUE@	gdbus-codegen.1
+am__append_1 = \
+	gapplication.1		\
+	gio-querymodules.1	\
+	glib-compile-schemas.1	\
+	glib-compile-resources.1	\
+	gsettings.1		\
+	gresource.1		\
+	gdbus.1			\
+	gdbus-codegen.1
 
 subdir = docs/reference/gio
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
diff -Nurd -x'*~' glib-2.48.1.orig/docs/reference/gio/glib-compile-schemas.1 glib-2.48.1/docs/reference/gio/glib-compile-schemas.1
--- glib-2.48.1.orig/docs/reference/gio/glib-compile-schemas.1	2016-04-27 06:18:44.000000000 -0400
+++ glib-2.48.1/docs/reference/gio/glib-compile-schemas.1	2016-07-08 01:56:35.000000000 -0400
@@ -50,7 +50,7 @@
 subdirectories of all directories specified in the
 \fBXDG_DATA_DIRS\fR
 environment variable\&. The usual location to install schema files is
-/usr/share/glib\-2\&.0/schemas\&.
+@PREFIX@/share/glib\-2\&.0/schemas\&.
 .PP
 In addition to schema files, glib\-compile\-schemas reads \*(Aqvendor override\*(Aq files, which are key files that can override default values for keys in the schemas\&. The group names in the key files are the schema id, and the values are written in serialized GVariant form\&. Vendor override files must have the filename extension
 \&.gschema\&.override\&.
diff -Nurd -x'*~' glib-2.48.1.orig/docs/reference/glib/Makefile.in glib-2.48.1/docs/reference/glib/Makefile.in
--- glib-2.48.1.orig/docs/reference/glib/Makefile.in	2016-05-10 05:05:54.000000000 -0400
+++ glib-2.48.1/docs/reference/glib/Makefile.in	2016-07-08 01:56:54.000000000 -0400
@@ -93,10 +93,10 @@
 POST_UNINSTALL = :
 build_triplet = @build@
 host_triplet = @host@
-@ENABLE_MAN_TRUE@am__append_1 = \
-@ENABLE_MAN_TRUE@	glib-gettextize.1 	\
-@ENABLE_MAN_TRUE@	gtester.1		\
-@ENABLE_MAN_TRUE@	gtester-report.1
+am__append_1 = \
+	glib-gettextize.1 	\
+	gtester.1		\
+	gtester-report.1
 
 subdir = docs/reference/glib
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
diff -Nurd -x'*~' glib-2.48.1.orig/docs/reference/gobject/Makefile.in glib-2.48.1/docs/reference/gobject/Makefile.in
--- glib-2.48.1.orig/docs/reference/gobject/Makefile.in	2016-05-10 05:05:54.000000000 -0400
+++ glib-2.48.1/docs/reference/gobject/Makefile.in	2016-07-08 01:57:06.000000000 -0400
@@ -93,10 +93,10 @@
 POST_UNINSTALL = :
 build_triplet = @build@
 host_triplet = @host@
-@ENABLE_MAN_TRUE@am__append_1 = \
-@ENABLE_MAN_TRUE@	glib-mkenums.1 		\
-@ENABLE_MAN_TRUE@	glib-genmarshal.1 	\
-@ENABLE_MAN_TRUE@	gobject-query.1
+am__append_1 = \
+	glib-mkenums.1 		\
+	glib-genmarshal.1 	\
+	gobject-query.1
 
 subdir = docs/reference/gobject
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
diff -Nurd -x'*~' glib-2.48.1.orig/gio/gdbusaddress.c glib-2.48.1/gio/gdbusaddress.c
--- glib-2.48.1.orig/gio/gdbusaddress.c	2016-04-25 07:48:48.000000000 -0400
+++ glib-2.48.1/gio/gdbusaddress.c	2016-07-08 01:57:39.000000000 -0400
@@ -1593,7 +1593,7 @@
       ret = g_strdup (g_getenv ("DBUS_SYSTEM_BUS_ADDRESS"));
       if (ret == NULL)
         {
-          ret = g_strdup ("unix:path=/var/run/dbus/system_bus_socket");
+          ret = g_strdup ("unix:path=@PREFIX@/var/run/dbus/system_bus_socket");
         }
       break;
 
diff -Nurd -x'*~' glib-2.48.1.orig/gio/gdbusprivate.c glib-2.48.1/gio/gdbusprivate.c
--- glib-2.48.1.orig/gio/gdbusprivate.c	2016-02-23 17:25:36.000000000 -0500
+++ glib-2.48.1/gio/gdbusprivate.c	2016-07-08 01:58:08.000000000 -0400
@@ -2068,7 +2068,7 @@
   /* TODO: use PACKAGE_LOCALSTATEDIR ? */
   ret = NULL;
   first_error = NULL;
-  if (!g_file_get_contents ("/var/lib/dbus/machine-id",
+  if (!g_file_get_contents ("@PREFIX@/var/lib/dbus/machine-id",
                             &ret,
                             NULL,
                             &first_error) &&
@@ -2078,7 +2078,7 @@
                             NULL))
     {
       g_propagate_prefixed_error (error, first_error,
-                                  _("Unable to load /var/lib/dbus/machine-id or /etc/machine-id: "));
+                                  _("Unable to load @PREFIX@/var/lib/dbus/machine-id or /etc/machine-id: "));
     }
   else
     {
diff -Nurd -x'*~' glib-2.48.1.orig/gio/gdesktopappinfo.c glib-2.48.1/gio/gdesktopappinfo.c
--- glib-2.48.1.orig/gio/gdesktopappinfo.c	2016-05-10 04:54:33.000000000 -0400
+++ glib-2.48.1/gio/gdesktopappinfo.c	2016-07-08 01:58:48.000000000 -0400
@@ -3460,7 +3460,7 @@
       g_file_set_contents (filename, contents, -1, NULL);
       g_free (contents);
 
-      run_update_command ("update-mime-database", "mime");
+      run_update_command ("@PREFIX@/bin/update-mime-database", "mime");
     }
   g_free (filename);
 
@@ -3618,7 +3618,7 @@
   info->filename = filename;
   info->desktop_id = desktop_id;
 
-  run_update_command ("update-desktop-database", "applications");
+  run_update_command ("@PREFIX@/bin/update-desktop-database", "applications");
 
   /* We just dropped a file in the user's desktop file directory.  Save
    * the monitor the bother of having to notice it and invalidate
diff -Nurd -x'*~' glib-2.48.1.orig/gio/gunixmounts.c glib-2.48.1/gio/gunixmounts.c
--- glib-2.48.1.orig/gio/gunixmounts.c	2016-02-23 17:25:36.000000000 -0500
+++ glib-2.48.1/gio/gunixmounts.c	2016-07-08 01:59:53.000000000 -0400
@@ -236,6 +236,7 @@
     "/tmp",
     "/usr",
     "/usr/X11R6",
+    "/usr/X11",
     "/usr/local",
     "/usr/obj",
     "/usr/ports",
@@ -253,6 +254,7 @@
     "/sbin",
     "/net",
     "/sys",
+    "@PREFIX@",
     NULL
   };
 
diff -Nurd -x'*~' glib-2.48.1.orig/gio/tests/Makefile.in glib-2.48.1/gio/tests/Makefile.in
--- glib-2.48.1.orig/gio/tests/Makefile.in	2016-05-10 05:05:55.000000000 -0400
+++ glib-2.48.1/gio/tests/Makefile.in	2016-07-08 02:08:49.000000000 -0400
@@ -127,12 +127,10 @@
 #  Test programs buildable on UNIX only
 
 # This is peer to peer so it doesn't need a session bus (so we can run it normally)
-@OS_UNIX_TRUE@am__append_14 = file gdbus-peer-object-manager \
+@OS_UNIX_TRUE@am__append_14 = gdbus-peer-object-manager \
 @OS_UNIX_TRUE@	gdbus-unix-addresses live-g-file socket-address \
 @OS_UNIX_TRUE@	stream-rw_all unix-fd unix-streams $(NULL) \
-@OS_UNIX_TRUE@	mimeapps gdbus-connection-flush gdbus-non-socket \
-@OS_UNIX_TRUE@	gdbus-peer
-
+@OS_UNIX_TRUE@	mimeapps connection-flush gdbus-non-socket
 # This test is currently unreliable
 @OS_UNIX_TRUE@am__append_15 = basic-application dbus-launch $(NULL) \
 @OS_UNIX_TRUE@	appinfo-test apps $(NULL) gsubprocess-testprog \
@@ -181,7 +179,6 @@
 
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@am__append_22 = \
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	actions					\
-@HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	dbus-appinfo				\
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gapplication				\
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gdbus-auth				\
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gdbus-bz627724				\
@@ -190,8 +187,6 @@
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gdbus-connection-loss			\
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gdbus-connection-slow			\
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gdbus-error				\
-@HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gdbus-exit-on-close			\
-@HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gdbus-export				\
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gdbus-introspection			\
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gdbus-names				\
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gdbus-proxy				\
@@ -210,7 +205,7 @@
 
 # -----------------------------------------------------------------------------
 @OS_WIN32_TRUE@am__append_26 = win32-streams
-@HAVE_DBUS1_TRUE@am__append_27 = gdbus-serialization
+@HAVE_DBUS1_TRUE@am__append_27 = 
 @HAVE_GCC_TRUE@am__append_28 = \
 @HAVE_GCC_TRUE@	autoptr				\
 @HAVE_GCC_TRUE@	$(NULL)
@@ -320,7 +315,7 @@
 @CROSS_COMPILING_FALSE@@ENABLE_INSTALLED_TESTS_TRUE@	-rpath \
 @CROSS_COMPILING_FALSE@@ENABLE_INSTALLED_TESTS_TRUE@	$(installed_testdir)
 am__EXEEXT_1 =
-@OS_UNIX_TRUE@am__EXEEXT_2 = file$(EXEEXT) \
+@OS_UNIX_TRUE@am__EXEEXT_2 = \
 @OS_UNIX_TRUE@	gdbus-peer-object-manager$(EXEEXT) \
 @OS_UNIX_TRUE@	gdbus-unix-addresses$(EXEEXT) \
 @OS_UNIX_TRUE@	live-g-file$(EXEEXT) socket-address$(EXEEXT) \
@@ -328,9 +323,8 @@
 @OS_UNIX_TRUE@	unix-streams$(EXEEXT) $(am__EXEEXT_1) \
 @OS_UNIX_TRUE@	mimeapps$(EXEEXT) \
 @OS_UNIX_TRUE@	gdbus-connection-flush$(EXEEXT) \
-@OS_UNIX_TRUE@	gdbus-non-socket$(EXEEXT) gdbus-peer$(EXEEXT)
+@OS_UNIX_TRUE@	gdbus-non-socket$(EXEEXT)
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@am__EXEEXT_3 = actions$(EXEEXT) \
-@HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	dbus-appinfo$(EXEEXT) \
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gapplication$(EXEEXT) \
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gdbus-auth$(EXEEXT) \
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gdbus-bz627724$(EXEEXT) \
@@ -339,8 +333,6 @@
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gdbus-connection-loss$(EXEEXT) \
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gdbus-connection-slow$(EXEEXT) \
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gdbus-error$(EXEEXT) \
-@HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gdbus-exit-on-close$(EXEEXT) \
-@HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gdbus-export$(EXEEXT) \
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gdbus-introspection$(EXEEXT) \
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gdbus-names$(EXEEXT) \
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gdbus-proxy$(EXEEXT) \
@@ -353,7 +345,7 @@
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	gnotification$(EXEEXT) \
 @HAVE_DBUS_DAEMON_TRUE@@OS_UNIX_TRUE@	$(am__EXEEXT_1)
 @OS_WIN32_TRUE@am__EXEEXT_4 = win32-streams$(EXEEXT)
-@HAVE_DBUS1_TRUE@am__EXEEXT_5 = gdbus-serialization$(EXEEXT)
+@HAVE_DBUS1_TRUE@am__EXEEXT_5 = 
 @HAVE_GCC_TRUE@am__EXEEXT_6 = autoptr$(EXEEXT) $(am__EXEEXT_1)
 @CROSS_COMPILING_FALSE@am__EXEEXT_7 = resources$(EXEEXT)
 am__EXEEXT_8 = appmonitor$(EXEEXT) async-close-output-stream$(EXEEXT) \
@@ -368,14 +360,14 @@
 	g-icon$(EXEEXT) gdbus-addresses$(EXEEXT) \
 	gdbus-message$(EXEEXT) inet-address$(EXEEXT) \
 	io-stream$(EXEEXT) memory-input-stream$(EXEEXT) \
-	memory-output-stream$(EXEEXT) monitor$(EXEEXT) \
+	memory-output-stream$(EXEEXT) \
 	network-address$(EXEEXT) network-monitor$(EXEEXT) \
 	permission$(EXEEXT) pollable$(EXEEXT) proxy-test$(EXEEXT) \
 	readwrite$(EXEEXT) simple-async-result$(EXEEXT) \
 	simple-proxy$(EXEEXT) sleepy-stream$(EXEEXT) socket$(EXEEXT) \
 	socket-listener$(EXEEXT) socket-service$(EXEEXT) \
 	srvtarget$(EXEEXT) task$(EXEEXT) tls-interaction$(EXEEXT) \
-	vfs$(EXEEXT) volumemonitor$(EXEEXT) glistmodel$(EXEEXT) \
+	vfs$(EXEEXT) glistmodel$(EXEEXT) \
 	testfilemonitor$(EXEEXT) $(am__EXEEXT_1) \
 	thumbnail-verification$(EXEEXT) tls-certificate$(EXEEXT) \
 	$(am__EXEEXT_2) $(am__EXEEXT_3) $(am__EXEEXT_4) \
@@ -2186,11 +2178,11 @@
 	data-output-stream defaultvalue fileattributematcher \
 	filter-streams giomodule gsubprocess g-file g-file-info g-icon \
 	gdbus-addresses gdbus-message inet-address io-stream \
-	memory-input-stream memory-output-stream monitor \
+	memory-input-stream memory-output-stream \
 	network-address network-monitor permission pollable proxy-test \
 	readwrite simple-async-result simple-proxy sleepy-stream \
 	socket socket-listener socket-service srvtarget task \
-	tls-interaction vfs volumemonitor glistmodel testfilemonitor \
+	tls-interaction vfs glistmodel testfilemonitor \
 	$(NULL) thumbnail-verification tls-certificate \
 	$(am__append_14) $(am__append_22) $(am__append_26) \
 	$(am__append_27) $(am__append_28) $(am__append_29)
diff -Nurd -x'*~' glib-2.48.1.orig/gio/tests/desktop-files/home/applications/epiphany-weather-for-toronto-island-9c6a4e022b17686306243dada811d550d25eb1fb.desktop glib-2.48.1/gio/tests/desktop-files/home/applications/epiphany-weather-for-toronto-island-9c6a4e022b17686306243dada811d550d25eb1fb.desktop
--- glib-2.48.1.orig/gio/tests/desktop-files/home/applications/epiphany-weather-for-toronto-island-9c6a4e022b17686306243dada811d550d25eb1fb.desktop	2014-07-04 19:59:10.000000000 -0400
+++ glib-2.48.1/gio/tests/desktop-files/home/applications/epiphany-weather-for-toronto-island-9c6a4e022b17686306243dada811d550d25eb1fb.desktop	2016-07-08 02:04:18.000000000 -0400
@@ -1,6 +1,6 @@
 [Desktop Entry]
 Name=Weather for Toronto Island
-Exec=/bin/true
+Exec=true
 StartupNotify=true
 Terminal=false
 Type=Application
diff -Nurd -x'*~' glib-2.48.1.orig/gio/tests/inet-address.c glib-2.48.1/gio/tests/inet-address.c
--- glib-2.48.1.orig/gio/tests/inet-address.c	2016-02-29 09:32:08.000000000 -0500
+++ glib-2.48.1/gio/tests/inet-address.c	2016-07-11 23:33:08.000000000 -0400
@@ -252,19 +252,19 @@
   g_object_unref (ia);
 
   /* IPv6. */
-  ia = g_inet_address_new_from_string ("::80");
+  ia = g_inet_address_new_from_string ("fe80::80");
   sa = g_inet_socket_address_new (ia, 80);
   str = g_socket_connectable_to_string (G_SOCKET_CONNECTABLE (sa));
-  g_assert_cmpstr (str, ==, "[::80]:80");
+  g_assert_cmpstr (str, ==, "[fe80::80]:80");
   g_free (str);
   g_object_unref (sa);
   g_object_unref (ia);
 
   /* IPv6 without port. */
-  ia = g_inet_address_new_from_string ("::80");
+  ia = g_inet_address_new_from_string ("fe80::80");
   sa = g_inet_socket_address_new (ia, 0);
   str = g_socket_connectable_to_string (G_SOCKET_CONNECTABLE (sa));
-  g_assert_cmpstr (str, ==, "::80");
+  g_assert_cmpstr (str, ==, "fe80::80");
   g_free (str);
   g_object_unref (sa);
   g_object_unref (ia);
diff -Nurd -x'*~' glib-2.48.1.orig/gio/tests/modules/Makefile.in glib-2.48.1/gio/tests/modules/Makefile.in
--- glib-2.48.1.orig/gio/tests/modules/Makefile.in	2016-05-10 05:05:55.000000000 -0400
+++ glib-2.48.1/gio/tests/modules/Makefile.in	2016-07-08 02:04:48.000000000 -0400
@@ -503,10 +503,10 @@
 @ENABLE_INSTALLED_TESTS_FALSE@rpath_hack = -rpath /
 libtestmodulea_la_SOURCES = test-module-a.c
 libtestmodulea_la_LIBADD = $(LDADD)
-libtestmodulea_la_LDFLAGS = $(LDFLAGS) -no-undefined -avoid-version $(rpath_hack)
+libtestmodulea_la_LDFLAGS = $(LDFLAGS) -module -no-undefined -avoid-version $(rpath_hack)
 libtestmoduleb_la_SOURCES = test-module-b.c
 libtestmoduleb_la_LIBADD = $(LDADD)
-libtestmoduleb_la_LDFLAGS = $(LDFLAGS) -no-undefined -avoid-version $(rpath_hack)
+libtestmoduleb_la_LDFLAGS = $(LDFLAGS) -module -no-undefined -avoid-version $(rpath_hack)
 all: all-am
 
 .SUFFIXES:
diff -Nurd -x'*~' glib-2.48.1.orig/gio/tests/pollable.c glib-2.48.1/gio/tests/pollable.c
--- glib-2.48.1.orig/gio/tests/pollable.c	2014-07-04 19:59:10.000000000 -0400
+++ glib-2.48.1/gio/tests/pollable.c	2016-07-08 02:10:36.000000000 -0400
@@ -24,6 +24,8 @@
 #include <gio/gunixinputstream.h>
 #include <gio/gunixoutputstream.h>
 #endif
+#include <stdlib.h>
+#define disable_by_env(flagvar) do { if (getenv(flagvar)) { g_test_skip("per request (" flagvar ")"); return; } } while(0)
 
 GMainLoop *loop;
 GPollableInputStream *in;
@@ -142,6 +144,8 @@
 static void
 test_pollable_unix (void)
 {
+  disable_by_env("DISABLE_pollable_unix_TEST");
+
   int pipefds[2], status, fd;
 
   status = pipe (pipefds);
@@ -172,6 +176,8 @@
 static void
 test_pollable_converter (void)
 {
+  disable_by_env("DISABLE_pollable_converter_TEST");
+
   GConverter *converter;
   GError *error = NULL;
   GInputStream *ibase;
diff -Nurd -x'*~' glib-2.48.1.orig/gio/xdgmime/xdgmime.c glib-2.48.1/gio/xdgmime/xdgmime.c
--- glib-2.48.1.orig/gio/xdgmime/xdgmime.c	2014-07-04 19:59:10.000000000 -0400
+++ glib-2.48.1/gio/xdgmime/xdgmime.c	2016-07-08 02:13:09.000000000 -0400
@@ -255,7 +255,7 @@
 
   xdg_data_dirs = getenv ("XDG_DATA_DIRS");
   if (xdg_data_dirs == NULL)
-    xdg_data_dirs = "/usr/local/share/:/usr/share/";
+    xdg_data_dirs = "@PREFIX@/share:/usr/local/share/:/usr/share/";
 
   ptr = xdg_data_dirs;
 
diff -Nurd -x'*~' glib-2.48.1.orig/glib/gslice.c glib-2.48.1/glib/gslice.c
--- glib-2.48.1.orig/glib/gslice.c	2016-02-29 09:32:08.000000000 -0500
+++ glib-2.48.1/glib/gslice.c	2016-07-08 02:15:19.000000000 -0400
@@ -1399,19 +1399,18 @@
                     gsize memsize)
 {
   gpointer aligned_memory = NULL;
-  gint err = ENOMEM;
 #if     HAVE_COMPLIANT_POSIX_MEMALIGN
+  gint err;
   err = posix_memalign (&aligned_memory, alignment, memsize);
+  if (!aligned_memory)
+    errno = err;
 #elif   HAVE_MEMALIGN
-  errno = 0;
   aligned_memory = memalign (alignment, memsize);
-  err = errno;
 #elif   HAVE_VALLOC
-  errno = 0;
   aligned_memory = valloc (memsize);
-  err = errno;
 #else
   /* simplistic non-freeing page allocator */
+  gint err = ENOMEM;
   mem_assert (alignment == sys_page_size);
   mem_assert (memsize <= sys_page_size);
   if (!compat_valloc_trash)
@@ -1430,9 +1429,9 @@
         }
     }
   aligned_memory = g_trash_stack_pop (&compat_valloc_trash);
-#endif
   if (!aligned_memory)
     errno = err;
+#endif
   return aligned_memory;
 }
 
diff -Nurd -x'*~' glib-2.48.1.orig/glib/gutils.c glib-2.48.1/glib/gutils.c
--- glib-2.48.1.orig/glib/gutils.c	2016-05-10 04:54:33.000000000 -0400
+++ glib-2.48.1/glib/gutils.c	2016-07-08 02:15:40.000000000 -0400
@@ -2017,7 +2017,7 @@
       conf_dirs = (gchar *) g_getenv ("XDG_CONFIG_DIRS");
 
       if (!conf_dirs || !conf_dirs[0])
-          conf_dirs = "/etc/xdg";
+          conf_dirs = "@PREFIX@/etc/xdg";
 
       conf_dir_vector = g_strsplit (conf_dirs, G_SEARCHPATH_SEPARATOR_S, 0);
 #endif
diff -Nurd -x'*~' glib-2.48.1.orig/glib/libcharset/Makefile.in glib-2.48.1/glib/libcharset/Makefile.in
--- glib-2.48.1.orig/glib/libcharset/Makefile.in	2016-05-10 05:05:56.000000000 -0400
+++ glib-2.48.1/glib/libcharset/Makefile.in	2016-07-08 02:25:15.000000000 -0400
@@ -774,7 +774,7 @@
 
 @ENABLE_INSTALLED_TESTS_TRUE@installed_test_meta_DATA = $(installed_testcases:=.test)
 AM_CPPFLAGS = \
-	-DLIBDIR=\"$(libdir)\" 		\
+	-DLIBDIR=\"$(sysconfdir)/glib-2.0\" 		\
 	$(config_h_INCLUDES)
 
 libcharset_la_CFLAGS = $(GLIB_HIDDEN_VISIBILITY_CFLAGS)
@@ -783,8 +783,8 @@
 	localcharset.h		\
 	localcharset.c
 
-charset_alias = $(DESTDIR)$(libdir)/charset.alias
-charset_tmp = $(DESTDIR)$(libdir)/charset.tmp
+charset_alias = $(DESTDIR)$(sysconfdir)/glib-2.0/charset.alias
+charset_tmp = $(DESTDIR)$(sysconfdir)/glib-2.0/charset.tmp
 SUFFIXES = .sed .sin
 all: $(BUILT_SOURCES)
 	$(MAKE) $(AM_MAKEFLAGS) all-am
@@ -1507,7 +1507,7 @@
 @ENABLE_INSTALLED_TESTS_TRUE@	echo 'Exec=$(installed_testdir)/$(notdir $<)' >> $@.tmp; \
 @ENABLE_INSTALLED_TESTS_TRUE@	mv $@.tmp $@)
 install-exec-local: all-local
-	$(mkinstalldirs) $(DESTDIR)$(libdir)
+	$(mkinstalldirs) $(DESTDIR)$(sysconfdir)/glib-2.0
 	if test -f $(charset_alias); then \
 	  sed -f ref-add.sed $(charset_alias) > $(charset_tmp) ; \
 	  $(INSTALL_DATA) $(charset_tmp) $(charset_alias) ; \
diff -Nurd -x'*~' glib-2.48.1.orig/glib/libcharset/charset.alias glib-2.48.1/glib/libcharset/charset.alias
--- glib-2.48.1.orig/glib/libcharset/charset.alias	1969-12-31 19:00:00.000000000 -0500
+++ glib-2.48.1/glib/libcharset/charset.alias	2016-07-08 02:24:26.000000000 -0400
@@ -0,0 +1,111 @@
+# This file contains a table of character encoding aliases,
+# suitable for operating system 'darwin'.
+C			ASCII
+bg_BG			UTF-8
+bg_BG.CP1251		CP1251
+cs_CZ			UTF-8
+cs_CZ.ISO8859-2		ISO-8859-2
+da_DK			UTF-8
+da_DK.ISO8859-1		ISO-8859-1
+da_DK.ISO8859-15	ISO-8859-15
+de_AT			UTF-8
+de_AT.ISO8859-1		ISO-8859-1
+de_AT.ISO8859-15	ISO-8859-15
+de_CH			UTF-8
+de_CH.ISO8859-1		ISO-8859-1
+de_CH.ISO8859-15	ISO-8859-15
+de_DE			UTF-8
+de_DE.ISO8859-1		ISO-8859-1
+de_DE.ISO8859-15	ISO-8859-15
+en_AU			UTF-8
+en_AU.ISO8859-1		ISO-8859-1
+en_AU.ISO8859-15	ISO-8859-15
+en_AU.US-ASCII		ASCII
+en_CA			UTF-8
+en_CA.ISO8859-1		ISO-8859-1
+en_CA.ISO8859-15	ISO-8859-15
+en_CA.US-ASCII		ASCII
+en_GB			UTF-8
+en_GB.ISO8859-1		ISO-8859-1
+en_GB.ISO8859-15	ISO-8859-15
+en_GB.US-ASCII		ASCII
+en_US			UTF-8
+en_US.ISO8859-1		ISO-8859-1
+en_US.ISO8859-15	ISO-8859-15
+en_US.US-ASCII		ASCII
+es_ES			UTF-8
+es_ES.ISO8859-1		ISO-8859-1
+es_ES.ISO8859-15	ISO-8859-15
+fi_FI			UTF-8
+fi_FI.ISO8859-1		ISO-8859-1
+fi_FI.ISO8859-15	ISO-8859-15
+fr_BE			UTF-8
+fr_BE.ISO8859-1		ISO-8859-1
+fr_BE.ISO8859-15	ISO-8859-15
+fr_CA			UTF-8
+fr_CA.ISO8859-1		ISO-8859-1
+fr_CA.ISO8859-15	ISO-8859-15
+fr_CH			UTF-8
+fr_CH.ISO8859-1		ISO-8859-1
+fr_CH.ISO8859-15	ISO-8859-15
+fr_FR			UTF-8
+fr_FR.ISO8859-1		ISO-8859-1
+fr_FR.ISO8859-15	ISO-8859-15
+hr_HR			UTF-8
+hr_HR.ISO8859-2		ISO-8859-2
+hu_HU			UTF-8
+hu_HU.ISO8859-2		ISO-8859-2
+is_IS			UTF-8
+is_IS.ISO8859-1		ISO-8859-1
+is_IS.ISO8859-15	ISO-8859-15
+it_CH			UTF-8
+it_CH.ISO8859-1		ISO-8859-1
+it_CH.ISO8859-15	ISO-8859-15
+it_IT			UTF-8
+it_IT.ISO8859-1		ISO-8859-1
+it_IT.ISO8859-15	ISO-8859-15
+ja_JP			UTF-8
+ja_JP.EUC		EUC-JP
+ja_JP.SJIS		SHIFT_JIS
+ko_KR			UTF-8
+ko_KR.EUC		EUC-KR
+la_LN			UTF-8
+la_LN.ISO8859-1		ISO-8859-1
+la_LN.ISO8859-2		ISO-8859-2
+la_LN.ISO8859-4		ISO-8859-4
+la_LN.ISO8859-15	ISO-8859-15
+la_LN.US-ASCII		ASCII
+lt_LT			UTF-8
+lt_LT.ISO8859-4		ISO-8859-4
+nl_BE			UTF-8
+nl_BE.ISO8869-1		ISO-8859-1
+nl_BE.ISO8869-15	ISO-8859-15
+nl_NL			UTF-8
+nl_NL.ISO8869-1		ISO-8859-1
+nl_NL.ISO8869-15	ISO-8859-15
+no_NO			UTF-8
+no_NO.ISO8869-1		ISO-8859-1
+no_NO.ISO8869-15	ISO-8859-15
+pl_PL			UTF-8
+pl_PL.ISO8859-2		ISO-8859-2
+pt_PT			UTF-8
+pt_PT.ISO8859-1		ISO-8859-1
+pt_PT.ISO8859-15	ISO-8859-15
+ru_RU			UTF-8
+ru_RU.CP866		CP866
+ru_RU.ISO8859-5		ISO-8859-5
+ru_RU.KOI8-R		KOI8-R
+ru_RU.cp1251		CP1251
+ru_RU.koi8r		KOI8-R
+sl_SI			UTF-8
+sl_SI.ISO8859-2		ISO-8859-2
+sv_SE			UTF-8
+sv_SE.ISO8859-1		ISO-8859-1
+sv_SE.ISO8859-15	ISO-8859-15
+uk_UA			UTF-8
+uk_UA.KOI8-U		KOI8-U
+uk_UA.cp1251		CP1251
+zh_CN			UTF-8
+zh_CN.EUC		GB2312
+zh_TW			UTF-8
+zh_TW.Big5		BIG5
diff -Nurd -x'*~' glib-2.48.1.orig/glib/tests/gdatetime.c glib-2.48.1/glib/tests/gdatetime.c
--- glib-2.48.1.orig/glib/tests/gdatetime.c	2016-05-10 04:54:30.000000000 -0400
+++ glib-2.48.1/glib/tests/gdatetime.c	2016-07-08 02:26:47.000000000 -0400
@@ -969,14 +969,14 @@
    */
   TEST_PRINTF ("%a", "\345\234\237");
   TEST_PRINTF ("%A", "\345\234\237\346\233\234\346\227\245");
-#ifndef HAVE_CARBON /* OSX just returns the number */
+#ifndef __APPLE__ /* OSX just returns the number */
   TEST_PRINTF ("%b", "10\346\234\210");
 #endif
   TEST_PRINTF ("%B", "10\346\234\210");
   TEST_PRINTF ("%d", "24");
   TEST_PRINTF_DATE (2009, 1, 1, "%d", "01");
   TEST_PRINTF ("%e", "24"); // fixme
-#ifndef HAVE_CARBON /* OSX just returns the number */
+#ifndef __APPLE__ /* OSX just returns the number */
   TEST_PRINTF ("%h", "10\346\234\210");
 #endif
   TEST_PRINTF ("%H", "00");
@@ -993,7 +993,7 @@
   TEST_PRINTF_TIME (10, 13, 13, "%l", "10");
   TEST_PRINTF ("%m", "10");
   TEST_PRINTF ("%M", "00");
-#ifndef HAVE_CARBON /* OSX returns latin "AM", not japanese */
+#ifndef __APPLE__ /* OSX returns latin "AM", not japanese */
   TEST_PRINTF ("%p", "\345\215\210\345\211\215");
   TEST_PRINTF_TIME (13, 13, 13, "%p", "\345\215\210\345\276\214");
   TEST_PRINTF ("%P", "\345\215\210\345\211\215");
@@ -1006,7 +1006,7 @@
   TEST_PRINTF ("%S", "00");
   TEST_PRINTF ("%t", "	");
   TEST_PRINTF ("%u", "6");
-#ifndef HAVE_CARBON /* OSX returns YYYY/MM/DD in ASCII */
+#ifndef __APPLE__ /* OSX returns YYYY/MM/DD in ASCII */
   TEST_PRINTF ("%x", "2009\345\271\26410\346\234\21024\346\227\245");
 #endif
   TEST_PRINTF ("%X", "00\346\231\20200\345\210\20600\347\247\222");
diff -Nurd -x'*~' glib-2.48.1.orig/glib/tests/markup-parse.c glib-2.48.1/glib/tests/markup-parse.c
--- glib-2.48.1.orig/glib/tests/markup-parse.c	2014-12-03 02:03:32.000000000 -0500
+++ glib-2.48.1/glib/tests/markup-parse.c	2016-07-08 02:28:38.000000000 -0400
@@ -234,12 +234,15 @@
 
   f = g_strdup (filename);
   p = strstr (f, ".gmarkup");
+  expected = NULL;
   if (p)
     *p = 0;
   if (flags == 0)
     expected = g_strconcat (f, ".expected", NULL);
   else if (flags == G_MARKUP_TREAT_CDATA_AS_TEXT)
     expected = g_strconcat (f, ".cdata-as-text", NULL);
+  else
+    g_warning("unknown implemented GMarkupParseFlags; returning NULL");
 
   g_free (f);
 
diff -Nurd -x'*~' glib-2.48.1.orig/glib/tests/spawn-singlethread.c glib-2.48.1/glib/tests/spawn-singlethread.c
--- glib-2.48.1.orig/glib/tests/spawn-singlethread.c	2014-12-03 02:03:32.000000000 -0500
+++ glib-2.48.1/glib/tests/spawn-singlethread.c	2016-07-08 02:31:24.000000000 -0400
@@ -25,6 +25,8 @@
 
 #include <glib.h>
 #include <string.h>
+#include <stdlib.h>
+#define disable_by_env(flagvar) do { if (getenv(flagvar)) { g_test_skip("per request (" flagvar ")"); return; }; } while(0)
 
 #ifdef G_OS_WIN32
 #define LINEEND "\r\n"
@@ -184,6 +186,8 @@
 static void
 test_spawn_script (void)
 {
+  disable_by_env("DISABLE_gthread_spawn_script_TEST");
+
   GError *error = NULL;
   GPtrArray *argv;
   char *stdout_str;
diff -Nurd -x'*~' glib-2.48.1.orig/tests/run-assert-msg-test.sh glib-2.48.1/tests/run-assert-msg-test.sh
--- glib-2.48.1.orig/tests/run-assert-msg-test.sh	2014-06-09 14:17:59.000000000 -0400
+++ glib-2.48.1/tests/run-assert-msg-test.sh	2016-07-08 02:36:06.000000000 -0400
@@ -27,6 +27,11 @@
   fi
 fi
 
+if [ $UID -ne 0 ]; then
+  echo_v "Skipped (cannot reliably run gdb as non-root)"
+  exit 0
+fi
+
 echo_v "Running assert-msg-test"
 OUT=$(./assert-msg-test 2>&1) && fail "assert-msg-test should abort"
 echo "$OUT" | grep -q '^GLib:ERROR:.*assert-msg-test.c:.*:.*main.*: assertion failed: (42 < 0)' || \
@@ -38,7 +43,7 @@
 fi
 
 echo_v "Running gdb on assert-msg-test"
-OUT=$($LIBTOOL --mode=execute gdb --batch -x ${srcdir:-.}/assert-msg-test.gdb ./assert-msg-test 2> $error_out) || fail "failed to run gdb"
+OUT=$($LIBTOOL --mode=execute /usr/bin/gdb --batch -x ${srcdir:-.}/assert-msg-test.gdb ./assert-msg-test 2> $error_out) || fail "failed to run gdb"
 
 echo_v "Checking if assert message is in __glib_assert_msg"
 if ! echo "$OUT" | grep -q '^$1.*"GLib:ERROR:.*assert-msg-test.c:.*:.*main.*: assertion failed: (42 < 0)"'; then
